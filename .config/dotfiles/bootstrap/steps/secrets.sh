#!/usr/bin/env bash
# æ­¥éª¤ï¼šåˆ›å»ºå¯†é’¥æ–‡ä»¶æ¨¡æ¿
# é‡è¦æ€§ï¼šOPTIONALï¼ˆå¯é€‰æ­¥éª¤ï¼‰
# ä¾èµ–ï¼šdotfiles

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$SCRIPT_DIR/lib/common.sh"

# ============================================================================
# æ­¥éª¤æè¿°
# ============================================================================
step_secrets_describe() {
  cat << 'EOF'
ğŸ”’ å¯†é’¥æ–‡ä»¶è®¾ç½®

å°†è¦æ‰§è¡Œçš„æ“ä½œï¼š
  1. åˆ›å»ºå¯†é’¥æ–‡ä»¶ç›®å½•ï¼ˆ~/.config/zsh/env.d/ï¼‰
  2. åˆ›å»ºå¯†é’¥æ–‡ä»¶æ¨¡æ¿ï¼ˆ90-secrets.zshï¼‰
  3. è®¾ç½®æ­£ç¡®çš„æƒé™ï¼ˆ600ï¼Œä»…æ‰€æœ‰è€…å¯è¯»å†™ï¼‰

ç”¨é€”è¯´æ˜ï¼š
  å¯†é’¥æ–‡ä»¶ç”¨äºå­˜å‚¨ä¸åº”æäº¤åˆ° git çš„æ•æ„Ÿä¿¡æ¯ï¼š
  â€¢ API å¯†é’¥å’Œä»¤ç‰Œ
  â€¢ å¯†ç å’Œè®¤è¯ä¿¡æ¯
  â€¢ ç§æœ‰ç¯å¢ƒå˜é‡
  â€¢ ä¸ªäººé…ç½®ï¼ˆé‚®ç®±ã€ç”¨æˆ·åç­‰ï¼‰

æ–‡ä»¶ä½ç½®ï¼š
  ~/.config/zsh/env.d/90-secrets.zsh

é£é™©æç¤ºï¼š
  â„¹ æ­¤æ–‡ä»¶å·²åœ¨ .gitignore ä¸­ï¼Œä¸ä¼šè¢« git è·Ÿè¸ª
  â„¹ æƒé™è®¾ç½®ä¸º 600ï¼Œå…¶ä»–ç”¨æˆ·æ— æ³•è¯»å–
  âš  è¯·å¦¥å–„ä¿ç®¡æ­¤æ–‡ä»¶ï¼Œä¸è¦åˆ†äº«å†…å®¹

ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€æ­¥ï¼š
  ä¸ºæ•æ„Ÿä¿¡æ¯æä¾›ç»Ÿä¸€çš„å­˜å‚¨ä½ç½®ï¼Œé¿å…ç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­
  Zsh ä¼šè‡ªåŠ¨åŠ è½½ env.d/ ç›®å½•ä¸‹çš„æ–‡ä»¶
EOF
}

# ============================================================================
# æ£€æŸ¥ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œ
# ============================================================================
step_secrets_check() {
  local ZDOTDIR="${ZDOTDIR:-${XDG_CONFIG_HOME:-$HOME/.config}/zsh}"
  local secrets_file="$ZDOTDIR/env.d/90-secrets.zsh"

  if [ -f "$secrets_file" ]; then
    info "å¯†é’¥æ–‡ä»¶å·²å­˜åœ¨ï¼š$secrets_file"

    # æ£€æŸ¥æƒé™
    local perms=$(stat -c %a "$secrets_file" 2>/dev/null || stat -f %A "$secrets_file" 2>/dev/null)
    if [ "$perms" != "600" ]; then
      warn "æƒé™ä¸æ­£ç¡®ï¼ˆå½“å‰ï¼š$permsï¼‰ï¼Œåº”è¯¥æ˜¯ 600"
      return 1  # éœ€è¦ä¿®å¤æƒé™
    fi

    return 0  # æ— éœ€æ‰§è¡Œ
  fi

  return 1  # éœ€è¦æ‰§è¡Œ
}

# ============================================================================
# æ‰§è¡Œï¼šåˆ›å»ºå¯†é’¥æ–‡ä»¶
# ============================================================================
step_secrets_run() {
  local ZDOTDIR="${ZDOTDIR:-${XDG_CONFIG_HOME:-$HOME/.config}/zsh}"
  local secrets_file="$ZDOTDIR/env.d/90-secrets.zsh"

  substep "åˆ›å»ºå¯†é’¥æ–‡ä»¶ç›®å½•"
  mkdir -p "$ZDOTDIR/env.d"
  success "ç›®å½•å·²åˆ›å»º"

  if [ -f "$secrets_file" ]; then
    substep "ä¿®å¤æ–‡ä»¶æƒé™"
    chmod 600 "$secrets_file"
    success "æƒé™å·²è®¾ç½®ä¸º 600"
  else
    substep "åˆ›å»ºå¯†é’¥æ–‡ä»¶æ¨¡æ¿"

    cat > "$secrets_file" << 'EOF'
#!/usr/bin/env zsh
# ============================================================================
# å¯†é’¥å’Œæ•æ„Ÿä¿¡æ¯é…ç½®æ–‡ä»¶
# ============================================================================
#
# æ­¤æ–‡ä»¶ç”¨äºå­˜å‚¨ä¸åº”æäº¤åˆ° git çš„æ•æ„Ÿä¿¡æ¯
# æ–‡ä»¶æƒé™ï¼š600ï¼ˆä»…æ‰€æœ‰è€…å¯è¯»å†™ï¼‰
# Git çŠ¶æ€ï¼šå·²åœ¨ .gitignore ä¸­å¿½ç•¥
#
# ç”¨æ³•ï¼š
#   1. å–æ¶ˆæ³¨é‡Šéœ€è¦çš„éƒ¨åˆ†
#   2. å¡«å†™å®é™…çš„å€¼
#   3. ä¿å­˜æ–‡ä»¶ï¼ˆæƒé™ä¼šè‡ªåŠ¨ä¿æŒä¸º 600ï¼‰
#
# ============================================================================

# ---- API å¯†é’¥å’Œä»¤ç‰Œ ----
# export OPENAI_API_KEY="sk-..."
# export ANTHROPIC_API_KEY="sk-ant-..."
# export GITHUB_TOKEN="ghp_..."

# ---- ä»£ç†è®¾ç½® ----
# export HTTP_PROXY="http://127.0.0.1:7890"
# export HTTPS_PROXY="http://127.0.0.1:7890"
# export ALL_PROXY="socks5://127.0.0.1:7891"

# ---- Git é…ç½®ï¼ˆå¦‚æœä¸ä¸»é…ç½®ä¸åŒï¼‰----
# export GIT_AUTHOR_NAME="Your Name"
# export GIT_AUTHOR_EMAIL="your.email@example.com"
# export GIT_COMMITTER_NAME="$GIT_AUTHOR_NAME"
# export GIT_COMMITTER_EMAIL="$GIT_AUTHOR_EMAIL"

# ---- è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ ----
# export MY_SECRET_VAR="secret_value"

# ---- ç§æœ‰ PATH æ·»åŠ  ----
# export PATH="$HOME/private/bin:$PATH"

# ============================================================================
# æç¤ºï¼šæ­¤æ–‡ä»¶åœ¨æ¯æ¬¡å¯åŠ¨ Zsh æ—¶è‡ªåŠ¨åŠ è½½
# ============================================================================
EOF

    chmod 600 "$secrets_file"
    success "å¯†é’¥æ–‡ä»¶å·²åˆ›å»º"
  fi

  return 0
}

# ============================================================================
# éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦æˆåŠŸ
# ============================================================================
step_secrets_verify() {
  local ZDOTDIR="${ZDOTDIR:-${XDG_CONFIG_HOME:-$HOME/.config}/zsh}"
  local secrets_file="$ZDOTDIR/env.d/90-secrets.zsh"

  if [ ! -f "$secrets_file" ]; then
    error "éªŒè¯å¤±è´¥ï¼šå¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨"
    return 1
  fi

  # æ£€æŸ¥æƒé™
  local perms=$(stat -c %a "$secrets_file" 2>/dev/null || stat -f %A "$secrets_file" 2>/dev/null)
  if [ "$perms" != "600" ]; then
    error "éªŒè¯å¤±è´¥ï¼šæƒé™ä¸æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯ 600ï¼Œå½“å‰æ˜¯ $permsï¼‰"
    return 1
  fi

  success "éªŒè¯é€šè¿‡ï¼šå¯†é’¥æ–‡ä»¶å·²æ­£ç¡®åˆ›å»º"
  return 0
}

# ============================================================================
# åç»­æç¤º
# ============================================================================
step_secrets_after() {
  local ZDOTDIR="${ZDOTDIR:-${XDG_CONFIG_HOME:-$HOME/.config}/zsh}"
  local secrets_file="$ZDOTDIR/env.d/90-secrets.zsh"

  info "åç»­æ“ä½œï¼š"
  echo "  â†’ ç¼–è¾‘å¯†é’¥æ–‡ä»¶ï¼š${BRIGHT_WHITE}$secrets_file${RESET}"
  echo "  â†’ å–æ¶ˆæ³¨é‡Šå¹¶å¡«å†™ä½ çš„æ•æ„Ÿä¿¡æ¯"
  echo ""
  info "ç¤ºä¾‹ï¼š"
  echo "  ${BRIGHT_CYAN}vim $secrets_file${RESET}"
  echo ""
  warn "æ³¨æ„ï¼š"
  echo "  â€¢ ä¸è¦å°†çœŸå®å¯†é’¥åˆ†äº«æˆ–æäº¤åˆ° git"
  echo "  â€¢ å¦‚æœéœ€è¦è·¨æœºå™¨åŒæ­¥ï¼Œè€ƒè™‘ä½¿ç”¨å¯†ç ç®¡ç†å™¨"
}

# ============================================================================
# ä¸»å…¥å£
# ============================================================================
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
  source "$SCRIPT_DIR/lib/steps.sh"
  step_execute "secrets"
fi
